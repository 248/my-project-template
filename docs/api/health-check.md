---
title: ヘルスチェックAPI仕様
author: @claude
created: 2025-09-04
updated: 2025-09-04
status: published
---

# ヘルスチェックAPI仕様

> システムの健全性監視・診断APIの完全仕様

## 🎯 概要

ヘルスチェックAPIは、アプリケーションとその依存関係（データベース、キャッシュ等）の健全性をリアルタイムで監視するためのエンドポイントです。依存性注入アーキテクチャにより、実際の接続テストを実行します。

## 🔗 エンドポイント一覧

### 1. 基本ヘルスチェック

```http
GET /health
```

システム全体の健全性を簡潔に返します。

**レスポンス**: システム全体の健全性状況を簡潔に返却

### 2. 詳細ヘルスチェック

```http
GET /health/detailed
```

各サービスの詳細な健全性情報を返します。

**レスポンス**: 各サービス（API・データベース・Redis）の詳細健全性情報とサマリー

## 📋 レスポンス仕様

### ステータス値

| Status      | 説明                         | HTTPコード |
| ----------- | ---------------------------- | ---------- |
| `healthy`   | 正常動作中                   | 200        |
| `degraded`  | 一部サービス異常だが動作可能 | 200        |
| `unhealthy` | 異常・利用不可               | 503        |

### レスポンス構造

#### 基本レスポンス

- `status`: 健全性状態（healthy/degraded/unhealthy）
- `message`: 状況説明メッセージ
- `responseTime`: 応答時間（ミリ秒）

#### 詳細レスポンス

- 基本レスポンスの全項目
- `services`: 各サービスの個別健全性情報
- `summary`: サービス数の集計情報

## 🔧 実装詳細

### サービス設計方針

- **依存性注入**: DIコンテナからサービス解決
- **実際のテスト**: モックではなく実際の接続テスト実行
- **リクエスト性質**: 必須サービス（database）とオプション（redis）
- **レスポンス時間計測**: 各サービスの応答性能監視

### ルート実装方針

- **ヘルスマネージャー**: サービス管理の中央制御
- **キャッシュ統合**: 頻繁なチェックの効率化
- **適切なHTTPステータス**: 503（Service Unavailable）での異常通知

実装詳細はソースコードを参照。

## 🧪 テスト・デバッグ

### テスト方針

- **基本動作確認**: `/health` エンドポイントで全体状況確認
- **詳細診断**: `/health/detailed` で個別サービス状況分析
- **異常系テスト**: 依存サービス停止時の動作確認
- **監視統合**: レスポンスヘッダー・ステータスコードでの自動判定

具体的なテストコマンドは開発環境で実行時に確認。

## 🔄 キャッシュ機能

### キャッシュ戦略

- **タイムアウト設定**: ヘルスチェック応答時間制限（5秒）
- **キャッシュ期間**: 成功結果の保持時間（30秒）
- **リトライ制御**: 失敗時の再試行回数制限
- **選択的キャッシュ**: 成功結果のみキャッシュ、異常時は毎回確認

## 🎯 監視・アラート活用

### Kubernetes統合

- **Liveness Probe**: `/health` で基本生存確認
- **Readiness Probe**: `/health/detailed` で詳細準備確認
- **障害検知**: HTTPステータス503での自動検知

### 監視システム連携

- **Prometheus**: メトリクス収集とアラート設定
- **ログ監視**: 構造化ログでの異常パターン検知
- **外部監視**: Uptimeロボット等での定期チェック

設定例は各監視システムのドキュメントを参照。

## 🔧 カスタマイゼーション

### 新しいヘルスチェック追加方針

- **HealthCheckService実装**: インターフェースに従った新サービス作成
- **外部API監視**: 外部依存サービスの生存確認
- **マネージャー登録**: 実行時のサービス追加
- **必須/オプション設定**: システム全体への影響度設定

### 設定カスタマイゼーション

- **タイムアウト調整**: サービス特性に応じた応答時間設定
- **キャッシュ期間調整**: 監視頻度要件に応じた設定
- **リトライ回数調整**: 可用性とレスポンス速度のバランス

実装方法は既存サービスの実装パターンを参照。

## 📚 関連ドキュメント

- [依存性注入アーキテクチャガイド](../architecture/dependency-injection.md)
- [設定管理ガイド](../architecture/configuration-management.md)
- [監視・オブザーバビリティガイド](../handbook/observability-guide.md)

---

**💡 Tips**: ヘルスチェックは本番環境でのシステム監視に必須です。定期的にエンドポイントを呼び出して、アプリケーションの健全性を監視することをお勧めします。
