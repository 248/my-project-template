---
title: 依存性注入アーキテクチャガイド
author: @claude
created: 2025-09-04
updated: 2025-09-04
status: published
---

# 依存性注入（DI）アーキテクチャガイド

> TSyringeを用いた依存性注入システムの設計と実装ガイド

## 🎯 概要

このプロジェクトでは、**TSyringe**を使用した依存性注入（DI）アーキテクチャを採用しています。これにより、以下の利点を実現しています：

- **テスタビリティ**: モックやスタブの注入が容易
- **保守性**: 依存関係の明確化と疎結合
- **拡張性**: 新しいサービス実装の追加が簡単
- **設定の一元管理**: 環境に応じた設定の注入

## 🏗️ アーキテクチャ構造

```
apps/backend/src/
├── interfaces/          # サービスインターフェース（契約）
│   ├── database.ts      # データベースサービス
│   ├── cache.ts         # キャッシュサービス
│   ├── logger.ts        # ロガーサービス
│   └── index.ts         # トークン定義
├── services/            # 具象実装
│   ├── database.ts      # Prisma実装
│   ├── cache.ts         # Redis実装
│   ├── logger.ts        # Pino実装
│   └── index.ts         # エクスポート
├── container/           # DIコンテナ設定
│   └── container.ts     # コンテナ初期化
└── config/              # 設定管理
    ├── database.ts      # DB設定（Zod）
    ├── redis.ts         # Redis設定（Zod）
    └── server.ts        # サーバー設定（Zod）
```

## 📋 実装パターン

### 1. サービスインターフェース設計

- インターフェースファーストでの設計
- サービストークンによるシンボル識別
- 契約駆動開発の実践

### 2. 具象実装の分離

- `@injectable()` デコレータによる注入対応
- インターフェース実装の強制
- 単一責務原則の遵守

### 3. コンテナ設定の一元管理

- アプリケーション起動時の一括登録
- 設定値の型安全な注入
- 実装切り替えの容易性確保

### 4. サービス利用方式

- コンストラクタインジェクション（推奨）
- 直接解決（特殊ケースのみ）
- 循環依存の回避

## 🔧 設定管理との統合

### 型安全な設定注入原則

- 環境変数はZodスキーマで検証後にDI注入
- 設定専用トークンによる分離
- サービスは設定依存を明示的にコンストラクタで受け取り

詳細は[設定管理ガイド](./configuration-management.md)を参照。

## 🧪 テスト戦略

### テスト用DI設計

- モックサービスの実装（インターフェース遵守）
- テスト前のコンテナ差し替え
- 子コンテナを活用した分離
- テストごとの独立性確保

DIを活用することで、外部依存を持つサービスのテストが容易になります。

## 🎯 ベストプラクティス

### DO ✅

- **インターフェースファーストで設計する**
- **設定はDIで注入する**
- **サービスの責務を明確にする**
- **エラーハンドリングを一貫して行う**

### DON'T ❌

- **直接的なサービスインスタンス化は避ける**
- **グローバル変数への依存は避ける**
- **サービス間の循環依存は避ける**

## 🔄 既存コードからの移行

### 移行戦略

- **段階的移行**: 一度に全体を変更せず、サービス単位で段階的に移行
- **インターフェース先行**: 既存機能のインターフェース化から開始
- **テスト保護**: 移行前にテストを整備し、動作保証を確保
- **設定外部化**: ハードコードされた値の設定管理システム移行

## 🚀 新しいサービス追加手順

1. **インターフェース定義** (`interfaces/`)
2. **具象実装作成** (`services/`)
3. **DIコンテナ登録** (`container/container.ts`)
4. **テスト実装** (`__tests__/`)

## 📚 関連ドキュメント

- [設定管理ガイド](./configuration-management.md)
- [テスト戦略](../handbook/testing-strategy.md)
- [実装ガイドライン](../meta/implementation-guidelines.md)

---

**💡 Tips**: DIコンテナは`setupContainer()`でアプリケーション起動時に一度だけ初期化されます。開発時はホットリロードで自動的に再初期化されます。
