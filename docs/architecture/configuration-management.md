---
title: 設定管理ガイド
author: @claude
created: 2025-09-04
updated: 2025-09-04
status: published
---

# 設定管理ガイド

> Zodスキーマによる型安全な設定管理と依存性注入との統合

## 🎯 概要

このプロジェクトでは**Zod**を使用した型安全な設定管理システムを採用しています。環境変数の検証、型変換、デフォルト値の設定を自動化し、依存性注入（DI）システムと統合しています。

## 🏗️ 設定管理アーキテクチャ

```
apps/backend/src/config/
├── database.ts          # データベース設定
├── redis.ts            # Redis設定
├── server.ts           # サーバー設定
└── index.ts            # 統合エクスポート
```

## 📋 実装パターン

### 1. Zodスキーマによる設定定義

設定値の型安全性を確保するため、Zodスキーマを使用：

- 環境変数の型変換・バリデーション
- デフォルト値の設定
- 説明的なdescribe()による文書化
- TypeScript型の自動生成

### 2. 複合設定の管理

複雑な設定（URL解析、条件分岐等）の場合：

- ファクトリ関数による設定構築
- URL形式と個別設定の両対応
- エラーハンドリングの一元化
- 設定変換ロジックの分離

### 3. 依存性注入との統合

設定をDIシステムで管理する原則：

- 検証済み設定値のコンテナ登録
- 設定専用トークンによる識別
- サービスへの自動注入

### 4. サービスでの設定利用

サービスは設定に依存せず、DIを通じて受け取る：

- コンストラクタでの設定注入
- 実行時設定変更の排除
- テスト時の設定差し替え対応

詳細は[依存性注入アーキテクチャガイド](./dependency-injection.md)を参照。

## 🔧 環境変数パターン

### 設定方式の指針

- **DATABASE_URL**: PostgreSQL接続情報の一元管理
- **REDIS_URL**: Redis接続情報（URL形式推奨）
- **LOG_LEVEL**: ログレベル制御
- **NODE_ENV**: 環境判定（development/production）

各設定の詳細は`.env.example`ファイルを参照。

## 🚀 設定検証とエラーハンドリング

### 検証戦略

- **起動時一括検証**: アプリケーション開始前にすべて検証
- **詳細エラー表示**: Zodエラーメッセージの分かりやすい変換
- **Fail Fast**: 設定不正時は即座に停止
- **ログ出力**: 検証結果の明確な可視化

## 🧪 テスト環境での設定

### テスト設定の方針

- **環境変数オーバーライド**: テスト固有の設定値を事前設定
- **テスト用DB**: 本番とは完全に分離されたデータベース
- **ログレベル調整**: テスト実行時のノイズ削減
- **設定モック**: 外部依存を排除したテスト実行

## 🎯 ベストプラクティス

### DO ✅

- **すべての環境変数をZodで検証する**
- **デフォルト値を適切に設定する**
- **説明的なdescribe()を使用する**
- **型安全な設定インターフェースを定義する**
- **エラーメッセージを分かりやすくする**

### DON'T ❌

- **検証されていない環境変数を直接使用しない**
- **マジックナンバーを避ける**
- **設定ファイルに機密情報を含めない**

## 🔄 設定追加手順

1. **Zodスキーマ定義** (`config/`)
2. **型インターフェース生成** (`z.infer`)
3. **DIコンテナ登録** (`container.ts`)
4. **サービス注入** (`@inject`)
5. **環境変数追加** (`.env.example`)

## 📚 関連ドキュメント

- [依存性注入アーキテクチャガイド](./dependency-injection.md)
- [開発者ガイド](../handbook/developer-guide.md)
- [環境構築ガイド](../handbook/environment-setup.md)

---

**💡 Tips**: 設定は起動時に一度だけ検証され、DIコンテナに保存されます。ランタイム中の設定変更は基本的にサポートされていません。
