FROM node:20-alpine

# pnpmをインストール
RUN corepack enable && corepack prepare pnpm@8.15.0 --activate

WORKDIR /app

# package.jsonと関連ファイルをコピー
COPY package.json pnpm-lock.yaml pnpm-workspace.yaml ./
COPY apps/backend/package.json ./apps/backend/
COPY packages/*/package.json ./packages/

# 依存関係をインストール
RUN pnpm install --no-frozen-lockfile

# ソースコードをコピー
COPY . .

# TypeScript型生成
RUN pnpm codegen

# 開発サーバーを起動
EXPOSE 8000
CMD ["pnpm", "--filter", "@template/backend", "dev"]