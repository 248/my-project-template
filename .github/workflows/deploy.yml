name: Deploy CI/CD

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_approval:
        description: '本番デプロイの承認をスキップ'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# 同一ブランチの古い実行を自動キャンセル（安全性向上）
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# 段階的移行用の環境変数（GitHub Settings > Variables で設定）
env:
  # false: テストをスキップしてデプロイ / true: テスト合格時のみデプロイ
  GATE_DEPLOY: ${{ vars.GATE_DEPLOY || 'false' }}
  # 依存関係チェック用
  PNPM_VERSION: '8.15.0'
  NODE_VERSION: '20'

jobs:
  # 変更検出ジョブ - どのパッケージが変更されたか判定
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      packages: ${{ steps.changes.outputs.packages }}
      infra: ${{ steps.changes.outputs.infra }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'apps/frontend/**'
              - 'packages/ui/**'
              - 'packages/design-system/**'
              - 'packages/api-contracts/**'
            backend:
              - 'apps/backend/**'
              - 'packages/api-contracts/**'
              - 'db/**'
            packages:
              - 'packages/**'
            infra:
              - '.github/workflows/**'
              - 'turbo.json'
              - 'package.json'
              - 'pnpm-workspace.yaml'

  # コード品質チェック（lint/type-check）
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: OpenAPI 型生成
        run: pnpm -w codegen

      - name: メッセージ型生成
        run: pnpm -w gen:messages

      - name: Prisma Client 生成
        run: pnpm --filter @template/backend exec prisma generate --schema ../../db/schema.prisma

      - name: 型チェック
        run: pnpm type-check
        continue-on-error: ${{ env.GATE_DEPLOY != 'true' }}

      - name: Lint
        run: pnpm lint
        continue-on-error: ${{ env.GATE_DEPLOY != 'true' }}

  # テスト実行
  test:
    runs-on: ubuntu-latest
    needs: [quality-check]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: テスト実行
        run: |
          echo "テストはまだ実装されていません - スキップ"
          # 将来的にテストを追加したら以下を有効化
          # pnpm test:run
        continue-on-error: true

  # フロントエンドのデプロイ（Vercel）
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-check, test]
    # フロントエンドまたは共通パッケージが変更された場合のみ実行
    if: |
      (needs.detect-changes.outputs.frontend == 'true' || 
       needs.detect-changes.outputs.packages == 'true' ||
       needs.detect-changes.outputs.infra == 'true') &&
      (github.event_name == 'pull_request' ||
       (github.event_name == 'push' && github.ref == 'refs/heads/main' &&
        (vars.GATE_DEPLOY != 'true' || needs.test.result == 'success')))
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
      prod-url: ${{ steps.deploy.outputs.prod-url }}
      url: ${{ steps.deploy.outputs.url }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: OpenAPI 型生成（フロントエンド）
        run: pnpm -w codegen

      - name: メッセージ型生成（フロントエンド）
        run: pnpm -w gen:messages

      - name: Prisma Client 生成（フロントエンド）
        run: pnpm --filter @template/backend exec prisma generate --schema ../../db/schema.prisma

      # Vercel CLI公式フローで環境変数取得 + ビルド + デプロイ（条件統一）
      - name: Build and Deploy with Vercel CLI
        working-directory: ./apps/frontend
        run: |
          echo "📋 VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}"
          echo "📋 VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "🔄 プレビュー環境用ビルド・デプロイ開始"
            npx vercel pull --yes --environment=preview --token=${{ secrets.VERCEL_TOKEN }}
            npx vercel build --token=${{ secrets.VERCEL_TOKEN }}
            DEPLOY_URL=$(npx vercel deploy --prebuilt --token=${{ secrets.VERCEL_TOKEN }})
            echo "preview-url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          else
            echo "⚠️ 本番環境デプロイは一時的にスキップ（未作成のため）"
            echo "prod-url=https://temporary-skip" >> $GITHUB_OUTPUT
            # echo "🚀 本番環境用ビルド・デプロイ開始"
            # npx vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}
            # npx vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}
            # DEPLOY_URL=$(npx vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }})
            # echo "prod-url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        id: vercel-deploy

      - name: Set output URLs
        id: deploy
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            URL="${{ steps.vercel-deploy.outputs.preview-url }}"
            echo "preview-url=$URL" >> $GITHUB_OUTPUT
            echo "url=$URL" >> $GITHUB_OUTPUT  # バックエンド用統一出力
          else
            URL="${{ steps.vercel-deploy.outputs.prod-url }}"
            echo "prod-url=$URL" >> $GITHUB_OUTPUT
            echo "url=$URL" >> $GITHUB_OUTPUT  # バックエンド用統一出力
          fi

      - name: PRにプレビューURLをコメント
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const url = '${{ steps.deploy.outputs.preview-url }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `🚀 **フロントエンドのプレビュー環境がデプロイされました！**\n\n👉 ${url}`
            });

  # バックエンドのデプロイ（Cloudflare Workers）
  deploy-backend:
    runs-on: ubuntu-latest
    needs: [detect-changes, deploy-frontend]
    # フロントエンド成功＋URL取得成功＋バックエンド変更時のみ実行
    if: |
      needs.deploy-frontend.result == 'success' &&
      needs.deploy-frontend.outputs.url != '' &&
      (needs.detect-changes.outputs.backend == 'true' || 
       needs.detect-changes.outputs.packages == 'true' ||
       needs.detect-changes.outputs.infra == 'true') &&
      (github.event_name == 'pull_request' ||
       (github.event_name == 'push' && github.ref == 'refs/heads/main'))
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: OpenAPI 型生成（バックエンド）
        run: pnpm -w codegen

      - name: メッセージ型生成（バックエンド）
        run: pnpm -w gen:messages

      - name: Prisma Client 生成（バックエンド）
        run: pnpm --filter @template/backend exec prisma generate --schema ../../db/schema.prisma

      - name: Build backend
        run: pnpm build:backend

      # CORS用フロントエンドURLを動的設定
      - name: Set FRONTEND_URL Secret (Preview)
        if: github.event_name == 'pull_request'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/backend
          command: |
            echo "${{ needs.deploy-frontend.outputs.url }}" | wrangler secret put FRONTEND_URL --env preview

      # 本番環境のFRONTEND_URLは固定（Cloudflare GUI設定済み）

      # プレビュー環境へのデプロイ
      - name: Deploy to Cloudflare Workers (Preview)
        if: github.event_name == 'pull_request'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/backend
          command: deploy --env preview

      # 本番環境へのデプロイ（現在は一時的にスキップ）
      - name: Deploy to Cloudflare Workers (Production)
        if: false # 本番環境は未作成のため一時的にスキップ
        # if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/backend
          command: deploy --env production

      - name: PRにAPIエンドポイントをコメント
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `🔧 **バックエンドAPIがプレビュー環境にデプロイされました！**\n\n👉 https://my-project-template-api-preview.workers.dev`
            });

  # 本番デプロイの承認ステップ
  production-approval:
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: |
      github.event_name == 'push' && 
      github.ref == 'refs/heads/main' &&
      github.event.inputs.skip_approval != 'true'
    environment:
      name: production
      url: ${{ needs.deploy-frontend.outputs.prod-url }}
    steps:
      - name: 本番デプロイ承認完了
        run: |
          echo "✅ 本番環境へのデプロイが承認されました"
          echo "Frontend: ${{ needs.deploy-frontend.outputs.prod-url }}"
          echo "Backend: https://my-project-template-api-production.workers.dev"

  # デプロイ成功通知
  notify-success:
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: success()
    steps:
      - name: Slack通知（オプション）
        if: vars.SLACK_WEBHOOK_URL != ''
        run: |
          echo "デプロイ成功をSlackに通知"
          # curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} ...

      - name: デプロイサマリー
        run: |
          echo "## 🎉 デプロイ完了"
          echo ""
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "### プレビュー環境"
            echo "- Frontend: ${{ needs.deploy-frontend.outputs.preview-url }}"
            echo "- Backend: https://my-project-template-api-preview.workers.dev"
          else
            echo "### 本番環境"
            echo "- Frontend: ${{ needs.deploy-frontend.outputs.prod-url }}"
            echo "- Backend: https://my-project-template-api-production.workers.dev"
          fi
