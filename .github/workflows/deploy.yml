name: Deploy CI/CD

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      skip_approval:
        description: 'æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã®æ‰¿èªã‚’ã‚¹ã‚­ãƒƒãƒ—'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# æ®µéšçš„ç§»è¡Œç”¨ã®ç’°å¢ƒå¤‰æ•°ï¼ˆGitHub Settings > Variables ã§è¨­å®šï¼‰
env:
  # false: ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ / true: ãƒ†ã‚¹ãƒˆåˆæ ¼æ™‚ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤
  GATE_DEPLOY: ${{ vars.GATE_DEPLOY || 'false' }}
  # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ç”¨
  PNPM_VERSION: '8.15.0'
  NODE_VERSION: '20'

jobs:
  # å¤‰æ›´æ¤œå‡ºã‚¸ãƒ§ãƒ– - ã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤‰æ›´ã•ã‚ŒãŸã‹åˆ¤å®š
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      packages: ${{ steps.changes.outputs.packages }}
      infra: ${{ steps.changes.outputs.infra }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'apps/frontend/**'
              - 'packages/ui/**'
              - 'packages/design-system/**'
              - 'packages/api-contracts/**'
            backend:
              - 'apps/backend/**'
              - 'packages/api-contracts/**'
              - 'db/**'
            packages:
              - 'packages/**'
            infra:
              - '.github/workflows/**'
              - 'turbo.json'
              - 'package.json'
              - 'pnpm-workspace.yaml'

  # ã‚³ãƒ¼ãƒ‰å“è³ªãƒã‚§ãƒƒã‚¯ï¼ˆlint/type-checkï¼‰
  quality-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
        run: pnpm codegen && pnpm gen:messages

      - name: å‹ãƒã‚§ãƒƒã‚¯
        run: pnpm type-check
        continue-on-error: ${{ env.GATE_DEPLOY != 'true' }}

      - name: Lint
        run: pnpm lint
        continue-on-error: ${{ env.GATE_DEPLOY != 'true' }}

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    runs-on: ubuntu-latest
    needs: [quality-check]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ãƒ†ã‚¹ãƒˆã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—"
          # å°†æ¥çš„ã«ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ãŸã‚‰ä»¥ä¸‹ã‚’æœ‰åŠ¹åŒ–
          # pnpm test:run
        continue-on-error: true

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆVercelï¼‰
  deploy-frontend:
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-check, test]
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¾ãŸã¯å…±é€šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      (needs.detect-changes.outputs.frontend == 'true' || 
       needs.detect-changes.outputs.packages == 'true' ||
       needs.detect-changes.outputs.infra == 'true') &&
      (github.event_name == 'pull_request' ||
       (github.event_name == 'push' && github.ref == 'refs/heads/main' &&
        (vars.GATE_DEPLOY != 'true' || needs.test.result == 'success')))
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
      prod-url: ${{ steps.deploy.outputs.prod-url }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate required files
        run: pnpm codegen && pnpm gen:messages

      # Vercel CLI ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã‚’ç’°å¢ƒå¤‰æ•°ã§æŒ‡å®šï¼‰
      - name: Build and Deploy with Vercel CLI
        working-directory: ./apps/frontend
        run: |
          echo "ğŸ“‹ Vercelãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã®ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"

          # ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›
          echo "Working directory: $(pwd)"
          echo "Vercel version: $(npx vercel --version)"

          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "ğŸ”„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒç”¨ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
            # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆè‡ªå‹•ãƒ“ãƒ«ãƒ‰ä»˜ãï¼‰
            DEPLOY_URL=$(npx vercel deploy --token=${{ secrets.VERCEL_TOKEN }} --confirm)
            echo "preview-url=$DEPLOY_URL" >> $GITHUB_OUTPUT
            echo "âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $DEPLOY_URL"
          else
            echo "âš ï¸ æœ¬ç•ªç’°å¢ƒãƒ‡ãƒ—ãƒ­ã‚¤ã¯ä¸€æ™‚çš„ã«ã‚¹ã‚­ãƒƒãƒ—ï¼ˆç’°å¢ƒæº–å‚™ä¸­ï¼‰"
            echo "prod-url=https://production-url-will-be-set-later" >> $GITHUB_OUTPUT
            # echo "ğŸš€ æœ¬ç•ªç’°å¢ƒç”¨ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹"
            # DEPLOY_URL=$(npx vercel deploy --prod --token=${{ secrets.VERCEL_TOKEN }} --confirm)
            # echo "prod-url=$DEPLOY_URL" >> $GITHUB_OUTPUT
          fi
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
          VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
          VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
        id: vercel-deploy

      - name: Set output URLs
        id: deploy
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "preview-url=${{ steps.vercel-deploy.outputs.preview-url }}" >> $GITHUB_OUTPUT
          else
            echo "prod-url=${{ steps.vercel-deploy.outputs.prod-url }}" >> $GITHUB_OUTPUT
          fi

      - name: PRã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const url = '${{ steps.deploy.outputs.preview-url }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼**\n\nğŸ‘‰ ${url}`
            });

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆCloudflare Workersï¼‰
  deploy-backend:
    runs-on: ubuntu-latest
    needs: [detect-changes, quality-check, test, deploy-frontend]
    # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¾ãŸã¯å…±é€šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      always() &&
      (needs.detect-changes.outputs.backend == 'true' || 
       needs.detect-changes.outputs.packages == 'true' ||
       needs.detect-changes.outputs.infra == 'true') &&
      (github.event_name == 'pull_request' ||
       (github.event_name == 'push' && github.ref == 'refs/heads/main' &&
        (vars.GATE_DEPLOY != 'true' || needs.test.result == 'success')))
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Generate required files
        run: pnpm codegen && pnpm gen:messages

      - name: Build backend
        run: pnpm build:backend

      # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå‹•çš„FRONTEND_URLè¨­å®šï¼‰
      - name: Deploy to Cloudflare Workers (Preview)
        if: github.event_name == 'pull_request'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/backend
          command: deploy --env preview
          secrets: |
            FRONTEND_URL
        env:
          FRONTEND_URL: ${{ needs.deploy-frontend.outputs.preview-url || 'http://localhost:3000' }}

      # æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆä¸€æ™‚çš„ã«ã‚¹ã‚­ãƒƒãƒ— - GUIè¨­å®šFRONTEND_URLä½¿ç”¨äºˆå®šï¼‰
      - name: Deploy to Cloudflare Workers (Production)
        if: false # æœ¬ç•ªç’°å¢ƒæº–å‚™ä¸­ã®ãŸã‚ä¸€æ™‚çš„ã«ã‚¹ã‚­ãƒƒãƒ—
        # if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/backend
          command: deploy --env production
          # Note: æœ¬ç•ªç’°å¢ƒã®FRONTEND_URLã¯Cloudflare GUIï¼ˆDashboardï¼‰ã‹ã‚‰äº‹å‰è¨­å®šæ¸ˆã¿

      - name: PRã«APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ”§ **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãŒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼**\n\nğŸ‘‰ https://my-project-template-api-preview.workers.dev`
            });

  # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã®æ‰¿èªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆç¾åœ¨ã¯æº–å‚™ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  production-approval:
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: false # æœ¬ç•ªç’°å¢ƒæº–å‚™ä¸­ã®ãŸã‚ä¸€æ™‚çš„ã«ã‚¹ã‚­ãƒƒãƒ—
    # if: |
    #   github.event_name == 'push' &&
    #   github.ref == 'refs/heads/main' &&
    #   github.event.inputs.skip_approval != 'true'
    environment:
      name: production
      url: ${{ needs.deploy-frontend.outputs.prod-url }}
    steps:
      - name: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªå®Œäº†
        run: |
          echo "âœ… æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ"
          echo "Frontend: ${{ needs.deploy-frontend.outputs.prod-url }}"
          echo "Backend: https://my-project-template-api-production.workers.dev"

  # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
  notify-success:
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: success()
    steps:
      - name: Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: vars.SLACK_WEBHOOK_URL != ''
        run: |
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã‚’Slackã«é€šçŸ¥"
          # curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} ...

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒãƒªãƒ¼
        run: |
          echo "## ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo ""
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ"
            echo "- Frontend: ${{ needs.deploy-frontend.outputs.preview-url }}"
            echo "- Backend: https://my-project-template-api-preview.workers.dev"
          else
            echo "### æœ¬ç•ªç’°å¢ƒ"
            echo "- Frontend: ${{ needs.deploy-frontend.outputs.prod-url }}"
            echo "- Backend: https://my-project-template-api-production.workers.dev"
          fi
