name: Deploy CI/CD

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - 'LICENSE'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
      - '.github/CODEOWNERS'
      - '.github/FUNDING.yml'
  push:
    branches: [main]
    paths-ignore:
      - 'docs/**'
      - '**/*.md'
      - 'LICENSE'
      - '.github/ISSUE_TEMPLATE/**'
      - '.github/PULL_REQUEST_TEMPLATE/**'
      - '.github/CODEOWNERS'
      - '.github/FUNDING.yml'
  workflow_dispatch:
    inputs:
      skip_approval:
        description: 'æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã®æ‰¿èªã‚’ã‚¹ã‚­ãƒƒãƒ—'
        required: false
        default: 'false'
        type: choice
        options:
          - 'true'
          - 'false'

# ç«¶åˆãƒ‡ãƒ—ãƒ­ã‚¤é˜²æ­¢ï¼ˆãƒ–ãƒ©ãƒ³ãƒå˜ä½ã§æœ€æ–°ã®ã¿å®Ÿè¡Œï¼‰
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# æœ€å°æ¨©é™è¨­å®šï¼ˆå¿…è¦ãªç®‡æ‰€ã§å€‹åˆ¥ã«æ˜‡æ ¼ï¼‰
permissions:
  contents: read

# æ®µéšçš„ç§»è¡Œç”¨ã®ç’°å¢ƒå¤‰æ•°ï¼ˆGitHub Settings > Variables ã§è¨­å®šï¼‰
env:
  # false: ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦ãƒ‡ãƒ—ãƒ­ã‚¤ / true: ãƒ†ã‚¹ãƒˆåˆæ ¼æ™‚ã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤
  GATE_DEPLOY: ${{ vars.GATE_DEPLOY || 'false' }}
  # ä¾å­˜é–¢ä¿‚ãƒã‚§ãƒƒã‚¯ç”¨
  PNPM_VERSION: '8.15.0'
  NODE_VERSION: '20'

jobs:
  # å¤‰æ›´æ¤œå‡ºã‚¸ãƒ§ãƒ– - ã©ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤‰æ›´ã•ã‚ŒãŸã‹åˆ¤å®š
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      frontend: ${{ steps.changes.outputs.frontend }}
      backend: ${{ steps.changes.outputs.backend }}
      packages: ${{ steps.changes.outputs.packages }}
      infra: ${{ steps.changes.outputs.infra }}
      docs-only: ${{ steps.changes.outputs.docs-only }}
      has_app_changes: ${{ steps.set.outputs.has_app_changes }}
    steps:
      - uses: actions/checkout@v4
      - uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            frontend:
              - 'apps/frontend/**'
              - 'packages/ui/**'
              - 'packages/design-system/**'
              - 'packages/api-contracts/**'
            backend:
              - 'apps/backend/**'
              - 'packages/api-contracts/**'
              - 'db/**'
            packages:
              - 'packages/**'
            infra:
              - '.github/workflows/**'
              - 'turbo.json'
              - 'package.json'
              - 'pnpm-workspace.yaml'
            docs-only:
              - 'docs/**'
              - '**/*.md'
              - 'LICENSE'
              - '.github/ISSUE_TEMPLATE/**'
              - '.github/PULL_REQUEST_TEMPLATE/**'
              - '.github/CODEOWNERS'
              - '.github/FUNDING.yml'
              - '.kiro/**/*.md'

      - name: Compose has_app_changes
        id: set
        run: |
          changed=$([ "${{ steps.changes.outputs.frontend }}" = "true" ] || \
                    [ "${{ steps.changes.outputs.backend  }}" = "true" ] || \
                    [ "${{ steps.changes.outputs.packages }}" = "true" ] || \
                    [ "${{ steps.changes.outputs.infra    }}" = "true" ] && echo true || echo false)
          echo "has_app_changes=$changed" >> "$GITHUB_OUTPUT"

  quality-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [detect-changes]
    # å¤‰æ›´ãŒãªã‘ã‚Œã°ã‚¹ã‚­ãƒƒãƒ—ï¼ˆå…ƒã®æ¡ä»¶ã‚’è¸è¥²ï¼‰
    if: needs.detect-changes.outputs.has_app_changes == 'true'
    env:
      CI: 'true'
      # PRã§ã¯ç·©ã‚ã€mainã¸ã®pushã§ã¯å³æ ¼ï¼ˆå¾“æ¥ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç°¡æ½”åŒ–ï¼‰
      GATE_DEPLOY: ${{ vars.GATE_DEPLOY != '' && vars.GATE_DEPLOY || (github.event_name == 'pull_request' && 'false' || 'true') }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies (workspace root)
        run: pnpm install --frozen-lockfile

      # --- ã“ã“ãŒè¦ç‚¹ï¼šapps/backend ã§1å›ã ã‘ Prisma Client ã‚’ç”Ÿæˆ ---
      - name: Prisma generate (apps/backend â†’ ../../db/schema.prisma)
        working-directory: apps/backend
        env:
          # ç”Ÿæˆæ™‚ã®è‡ªå‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã¯æŠ‘æ­¢ï¼ˆä¾å­˜ã¯ä¸Šã® pnpm install ã§è§£æ±ºæ¸ˆã¿ï¼‰
          PRISMA_GENERATE_SKIP_AUTOINSTALL: 'true'
        run: |
          echo "ğŸ”§ prisma generate é–‹å§‹"
          pnpm exec prisma generate --schema ../../db/schema.prisma
          echo "âœ… prisma generate å®Œäº†"

      # ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆå¿…è¦æœ€å°é™ï¼‰
      - name: Codegen (OpenAPI / Messages)
        run: pnpm codegen && pnpm gen:messages

      # å‹ãƒã‚§ãƒƒã‚¯ï¼ˆPRæ™‚ã¯è¨±å®¹ / æœ¬ç•ªç³»ã¯å¤±æ•—ã«ã™ã‚‹ï¼‰
      - name: Type check
        run: pnpm type-check
        continue-on-error: ${{ env.GATE_DEPLOY != 'true' }}

      # Lintï¼ˆè­¦å‘Šã‚‚å¤±æ•—æ‰±ã„ãƒ»ãŸã ã—PRã§ã¯è¨±å®¹ï¼‰
      - name: Lint
        run: pnpm lint --max-warnings=0
        continue-on-error: ${{ env.GATE_DEPLOY != 'true' }}

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [quality-check]
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
        run: |
          echo "ãƒ†ã‚¹ãƒˆã¯ã¾ã å®Ÿè£…ã•ã‚Œã¦ã„ã¾ã›ã‚“ - ã‚¹ã‚­ãƒƒãƒ—"
          # å°†æ¥çš„ã«ãƒ†ã‚¹ãƒˆã‚’è¿½åŠ ã—ãŸã‚‰ä»¥ä¸‹ã‚’æœ‰åŠ¹åŒ–
          # pnpm test:run
        continue-on-error: true

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆVercelï¼‰
  deploy-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    permissions:
      contents: read
      pull-requests: write # PRã‚³ãƒ¡ãƒ³ãƒˆç”¨
    needs: [detect-changes, quality-check, test]
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã¾ãŸã¯å…±é€šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      (needs.detect-changes.outputs.frontend == 'true' || 
       needs.detect-changes.outputs.packages == 'true' ||
       needs.detect-changes.outputs.infra == 'true') &&
      (github.event_name == 'pull_request' ||
       (github.event_name == 'push' && github.ref == 'refs/heads/main' &&
        (vars.GATE_DEPLOY != 'true' || needs.test.result == 'success')))
    outputs:
      preview-url: ${{ steps.deploy.outputs.preview-url }}
      prod-url: ${{ steps.deploy.outputs.prod-url }}
    env:
      VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
      VERCEL_ORG_ID: ${{ secrets.VERCEL_ORG_ID }}
      VERCEL_PROJECT_ID: ${{ secrets.VERCEL_PROJECT_ID }}
    # Vercelå´Root Directoryè¨­å®šï¼ˆapps/frontendï¼‰ã‚’æ´»ç”¨
    # CLIå¸¸ã«ãƒ«ãƒ¼ãƒˆå®Ÿè¡Œã§Root Directoryè¨­å®šã«å§”ã­ã‚‹ï¼ˆæ–¹é‡Aï¼‰
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      # ä¾å­˜é–¢ä¿‚ã¯ãƒ¢ãƒãƒ¬ãƒã®ãƒ«ãƒ¼ãƒˆã§è§£æ±ºï¼ˆlockfileä¸€è²«æ€§ã®ãŸã‚ï¼‰
      - name: Install dependencies (root)
        working-directory: .
        run: pnpm install --frozen-lockfile

      # Prisma Clientç”Ÿæˆ
      - name: Ensure backend dependencies
        run: pnpm --filter @template/backend install --frozen-lockfile

      - name: Assert Prisma deps & environment
        run: |
          echo "ğŸ” Environment & tool versions:"
          node -v && pnpm -v
          echo "ğŸ” Verifying Prisma dependencies in backend workspace..."
          pnpm --filter @template/backend ls @prisma/client --depth 0 || echo "âŒ @prisma/client not found in backend"
          pnpm --filter @template/backend ls prisma --depth 0 || echo "âŒ prisma CLI not found in backend"
          echo "ğŸ“ Backend working directory check:"
          ls -la apps/backend/node_modules/@prisma/client 2>/dev/null && echo "âœ… @prisma/client symlink exists" || echo "âŒ @prisma/client symlink missing"

      - name: Prisma Debug & Generate
        working-directory: apps/backend
        env:
          PRISMA_GENERATE_SKIP_AUTOINSTALL: 'true'
        run: |
          echo "ğŸ” === PRISMA è©³ç´°è¨ºæ–­é–‹å§‹ ==="
          echo "ğŸ“ Current PWD: $(pwd)"
          echo "ğŸ“ Repository structure:"
          find /home/runner/work/my-project-template/my-project-template -name "schema.prisma" -type f 2>/dev/null || echo "No schema.prisma found"
          echo "ğŸ“ Current directory contents:"
          ls -la .
          echo "ğŸ“ Parent directories:"
          ls -la ../
          ls -la ../../
          echo "ğŸ“ Database directory check:"
          ls -la ../../db/ 2>/dev/null || echo "No db directory found"
          echo "ğŸ“ Schema file verification:"
          [ -f ../../db/schema.prisma ] && echo "âœ… Schema exists at ../../db/schema.prisma" || echo "âŒ Schema missing at ../../db/schema.prisma"
          [ -f ../db/schema.prisma ] && echo "âœ… Schema exists at ../db/schema.prisma" || echo "âŒ Schema missing at ../db/schema.prisma"
          [ -f db/schema.prisma ] && echo "âœ… Schema exists at db/schema.prisma" || echo "âŒ Schema missing at db/schema.prisma"
          echo "ğŸ“ Prisma CLI check:"
          pnpm exec prisma --version || echo "Prisma CLI not available"
          echo "ğŸ“ Package.json scripts:"
          cat package.json | grep -A 10 -B 2 "scripts" || echo "No scripts found"
          echo "ğŸ“ ç”Ÿæˆå…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ: mkdir -p generated/prisma"
          mkdir -p generated/prisma
          echo "ğŸ”§ Attempting Prisma generate with different paths:"
          echo "--- Method 1: ../../db/schema.prisma ---"
          pnpm exec prisma generate --schema ../../db/schema.prisma 2>&1 || echo "Method 1 failed"
          echo "--- Method 2: ../db/schema.prisma ---"  
          pnpm exec prisma generate --schema ../db/schema.prisma 2>&1 || echo "Method 2 failed"
          echo "--- Method 3: Using package.json script ---"
          pnpm run db:generate 2>&1 || echo "Method 3 failed - script not available"
          echo "ğŸ” === PRISMA è©³ç´°è¨ºæ–­çµ‚äº† ==="

      # ã‚³ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆãƒ«ãƒ¼ãƒˆã‹ã‚‰å®Ÿè¡Œï¼‰
      - name: Generate required files
        working-directory: .
        run: pnpm codegen && pnpm gen:messages

      # ãƒ‘ã‚¹æ¤œè¨¼ï¼ˆãƒªãƒã‚¸ãƒˆãƒªãƒ«ãƒ¼ãƒˆã‹ã‚‰å®Ÿè¡Œï¼‰
      - name: Assert PWD and files (repo root)
        working-directory: .
        run: |
          echo "PWD=$(pwd)"
          ls -la
          test -d apps/frontend || (echo "apps/frontend ãŒã‚ã‚Šã¾ã›ã‚“" && exit 1)
          test -f apps/frontend/package.json || (echo "apps/frontend/package.json ãŒã‚ã‚Šã¾ã›ã‚“" && exit 1)
          echo "âœ… Working directory validation completed"

      # âœ… ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒªãƒ³ã‚¯ã‚’ãƒªãƒã‚¸ãƒˆãƒªç›´ä¸‹ã«å›ºå®šï¼ˆæ–¹é‡Aï¼‰
      - name: Vercel link (bind project at repo root)
        working-directory: .
        run: npx vercel@latest link --yes --project "$VERCEL_PROJECT_ID" --token "$VERCEL_TOKEN"

      # âœ… ç’°å¢ƒã®å–ã‚Šè¾¼ã¿ï¼ˆãƒªãƒã‚¸ãƒˆãƒªãƒ«ãƒ¼ãƒˆã‹ã‚‰å®Ÿè¡Œï¼‰
      - name: Vercel pull (preview)
        if: github.event_name == 'pull_request'
        working-directory: .
        run: npx vercel@latest pull --yes --environment=preview --token "$VERCEL_TOKEN"

      - name: Vercel pull (production)
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        working-directory: .
        run: npx vercel@latest pull --yes --environment=production --token "$VERCEL_TOKEN"

      # ğŸš€ ãƒªãƒ¢ãƒ¼ãƒˆãƒ“ãƒ«ãƒ‰ã§ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆãƒªãƒã‚¸ãƒˆãƒªãƒ«ãƒ¼ãƒˆã‹ã‚‰å®Ÿè¡Œï¼‰
      - name: Deploy with Vercel CLI (remote build)
        id: deploy
        if: github.event_name == 'pull_request'
        working-directory: .
        run: |
          echo "ğŸ”„ ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒç”¨ãƒ‡ãƒ—ãƒ­ã‚¤é–‹å§‹ï¼ˆVercelå´ãƒªãƒ¢ãƒ¼ãƒˆãƒ“ãƒ«ãƒ‰ï¼‰"
          echo "Debug: PWD=$(pwd)"
          echo "Debug: .vercel exists? $(test -d .vercel && echo 'YES' || echo 'NO')"
          DEPLOY_URL=$(npx vercel@latest deploy --yes --token "$VERCEL_TOKEN")
          echo "preview-url=$DEPLOY_URL" >> "$GITHUB_OUTPUT"
          echo "âœ… ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†: $DEPLOY_URL"

      - name: Skip production deploy for now
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          echo "âš ï¸ æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã¯ä¸€æ™‚çš„ã«ã‚¹ã‚­ãƒƒãƒ—ä¸­"
          echo "prod-url=https://production-url-will-be-set-later" >> "$GITHUB_OUTPUT"

      - name: PRã«ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const url = '${{ steps.deploy.outputs.preview-url }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸš€ **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼**\n\nğŸ‘‰ ${url}`
            });

  # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®URLã‚’è§£æ±ºï¼ˆãƒ•ãƒ­ãƒ³ãƒˆæœªå¤‰æ›´ã§ã‚‚ã€éå»ã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰å–å¾—ï¼‰
  resolve-frontend-url:
    runs-on: ubuntu-latest
    needs: [deploy-frontend]
    if: github.event_name == 'pull_request'
    outputs:
      url: ${{ steps.resolve.outputs.url }}
      origin: ${{ steps.resolve.outputs.origin }}
    steps:
      - name: Resolve preview URL from outputs or PR comments
        id: resolve
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const direct = `${{ needs.deploy-frontend.outputs.preview-url }}`.trim();
            let url = direct;
            if (!url) {
              const { data: comments } = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                per_page: 50,
              });
              // æœ€æ–°ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLã‚³ãƒ¡ãƒ³ãƒˆã‚’å¾Œæ–¹ã‹ã‚‰æ¢ç´¢
              for (let i = comments.length - 1; i >= 0; i--) {
                const body = comments[i].body || '';
                if (body.includes('ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒãŒãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸ')) {
                  const match = body.match(/https?:\/\/[^\s)]+/);
                  if (match) {
                    url = match[0];
                    break;
                  }
                }
              }
            }
            if (!url) {
              core.warning('ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒ­ãƒ¼ã‚«ãƒ«æ—¢å®šã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
              url = 'http://localhost:3000';
            }
            // ã‚ªãƒªã‚¸ãƒ³ã¸æ­£è¦åŒ–
            let origin = url;
            try { origin = new URL(url).origin; } catch (e) { core.warning('URLæ­£è¦åŒ–ã«å¤±æ•—: ' + e.message); }
            core.setOutput('url', url);
            core.setOutput('origin', origin);

  # ãƒ•ãƒ­ãƒ³ãƒˆã®ã¿å¤‰æ›´æ™‚ã¯ã€Workersã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã›ãš CORS_ORIGIN ã ã‘åŒæœŸ
  sync-cors-origin:
    runs-on: ubuntu-latest
    needs: [detect-changes, resolve-frontend-url]
    if: needs.detect-changes.outputs.frontend == 'true' && needs.detect-changes.outputs.backend != 'true' && github.event_name == 'pull_request'
    steps:
      - name: Sync CORS_ORIGIN and redeploy backend (Preview)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/backend
          packageManager: pnpm
          wranglerVersion: 4.34.0
          command: deploy --env preview
          environment: preview
          vars: |
            CORS_ORIGIN
        env:
          # æ—¢å­˜ã®ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚’å†ãƒ‡ãƒ—ãƒ­ã‚¤ã—ã¦CORS_ORIGINã‚’åæ˜ 
          CORS_ORIGIN: ${{ needs.resolve-frontend-url.outputs.origin || 'http://localhost:3000' }}

  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆCloudflare Workersï¼‰
  deploy-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    permissions:
      contents: read
      pull-requests: write # PRã‚³ãƒ¡ãƒ³ãƒˆç”¨
    needs:
      [
        detect-changes,
        quality-check,
        test,
        deploy-frontend,
        resolve-frontend-url,
      ]
    # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãŒæˆåŠŸã—ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¾ãŸã¯å…±é€šãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãŒå¤‰æ›´ã•ã‚ŒãŸå ´åˆã®ã¿å®Ÿè¡Œ
    if: |
      (needs.deploy-frontend.result == 'success' || needs.deploy-frontend.result == 'skipped') &&
      (needs.detect-changes.outputs.backend == 'true' || 
       needs.detect-changes.outputs.packages == 'true' ||
       needs.detect-changes.outputs.infra == 'true') &&
      (github.event_name == 'pull_request' ||
       (github.event_name == 'push' && github.ref == 'refs/heads/main' &&
        (vars.GATE_DEPLOY != 'true' || needs.test.result == 'success')))
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Ensure backend dependencies
        run: pnpm --filter @template/backend install --frozen-lockfile

      - name: Assert Prisma deps & environment
        run: |
          echo "ğŸ” Environment & tool versions:"
          node -v && pnpm -v
          echo "ğŸ” Verifying Prisma dependencies in backend workspace..."
          pnpm --filter @template/backend ls @prisma/client --depth 0 || echo "âŒ @prisma/client not found in backend"
          pnpm --filter @template/backend ls prisma --depth 0 || echo "âŒ prisma CLI not found in backend"
          echo "ğŸ“ Backend working directory check:"
          ls -la apps/backend/node_modules/@prisma/client 2>/dev/null && echo "âœ… @prisma/client symlink exists" || echo "âŒ @prisma/client symlink missing"

      - name: Prisma Debug & Generate
        working-directory: apps/backend
        env:
          PRISMA_GENERATE_SKIP_AUTOINSTALL: 'true'
        run: |
          echo "ğŸ” === PRISMA è©³ç´°è¨ºæ–­é–‹å§‹ ==="
          echo "ğŸ“ Current PWD: $(pwd)"
          echo "ğŸ“ Repository structure:"
          find /home/runner/work/my-project-template/my-project-template -name "schema.prisma" -type f 2>/dev/null || echo "No schema.prisma found"
          echo "ğŸ“ Current directory contents:"
          ls -la .
          echo "ğŸ“ Parent directories:"
          ls -la ../
          ls -la ../../
          echo "ğŸ“ Database directory check:"
          ls -la ../../db/ 2>/dev/null || echo "No db directory found"
          echo "ğŸ“ Schema file verification:"
          [ -f ../../db/schema.prisma ] && echo "âœ… Schema exists at ../../db/schema.prisma" || echo "âŒ Schema missing at ../../db/schema.prisma"
          [ -f ../db/schema.prisma ] && echo "âœ… Schema exists at ../db/schema.prisma" || echo "âŒ Schema missing at ../db/schema.prisma"
          [ -f db/schema.prisma ] && echo "âœ… Schema exists at db/schema.prisma" || echo "âŒ Schema missing at db/schema.prisma"
          echo "ğŸ“ Prisma CLI check:"
          pnpm exec prisma --version || echo "Prisma CLI not available"
          echo "ğŸ“ Package.json scripts:"
          cat package.json | grep -A 10 -B 2 "scripts" || echo "No scripts found"
          echo "ğŸ“ ç”Ÿæˆå…ˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªä½œæˆ: mkdir -p generated/prisma"
          mkdir -p generated/prisma
          echo "ğŸ”§ Attempting Prisma generate with different paths:"
          echo "--- Method 1: ../../db/schema.prisma ---"
          pnpm exec prisma generate --schema ../../db/schema.prisma 2>&1 || echo "Method 1 failed"
          echo "--- Method 2: ../db/schema.prisma ---"  
          pnpm exec prisma generate --schema ../db/schema.prisma 2>&1 || echo "Method 2 failed"
          echo "--- Method 3: Using package.json script ---"
          pnpm run db:generate 2>&1 || echo "Method 3 failed - script not available"
          echo "ğŸ” === PRISMA è©³ç´°è¨ºæ–­çµ‚äº† ==="

      - name: Generate required files
        run: pnpm codegen && pnpm gen:messages

      - name: Build backend
        run: pnpm build:backend

      # ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆå‹•çš„CORS_ORIGINè¨­å®šï¼‰
      - name: Deploy to Cloudflare Workers (Preview)
        id: cf-deploy
        if: github.event_name == 'pull_request'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/backend
          packageManager: pnpm # â† npm ã‚’ä½¿ã‚ã›ãªã„
          wranglerVersion: 4.34.0 # â† 4ç³»ã§ãƒ”ãƒ³ç•™ã‚ï¼ˆä¾‹ï¼‰
          command: deploy --env preview
          environment: preview
          vars: |
            CORS_ORIGIN
        env:
          # ãƒ•ãƒ­ãƒ³ãƒˆãŒæœªæ›´æ–°ã§ã‚‚ã€éå»ã®PRã‚³ãƒ¡ãƒ³ãƒˆã‹ã‚‰è§£æ±ºã—ãŸã‚ªãƒªã‚¸ãƒ³ã‚’ä½¿ç”¨
          CORS_ORIGIN: ${{ needs.resolve-frontend-url.outputs.origin || 'http://localhost:3000' }}

      # æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ï¼ˆä¸€æ™‚çš„ã«ã‚¹ã‚­ãƒƒãƒ— - GUIè¨­å®šCORS_ORIGINä½¿ç”¨äºˆå®šï¼‰
      - name: Deploy to Cloudflare Workers (Production)
        if: false # æœ¬ç•ªç’°å¢ƒæº–å‚™ä¸­ã®ãŸã‚ä¸€æ™‚çš„ã«ã‚¹ã‚­ãƒƒãƒ—
        # if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          workingDirectory: ./apps/backend
          packageManager: pnpm
          wranglerVersion: 4.34.0
          command: deploy --env production
          # Note: æœ¬ç•ªç’°å¢ƒã®CORS_ORIGINã¯Cloudflare GUIï¼ˆDashboardï¼‰ã‹ã‚‰äº‹å‰è¨­å®šæ¸ˆã¿

      - name: PRã«APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆã‚’ã‚³ãƒ¡ãƒ³ãƒˆ
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const url = '${{ steps.cf-deploy.outputs.deployment-url }}';
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ”§ **ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰APIãŒãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒã«ãƒ‡ãƒ—ãƒ­ã‚¤ã•ã‚Œã¾ã—ãŸï¼**\n\nğŸ‘‰ ${url}`
            });

  # æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤ã®æ‰¿èªã‚¹ãƒ†ãƒƒãƒ—ï¼ˆç¾åœ¨ã¯æº–å‚™ä¸­ã®ãŸã‚ã‚¹ã‚­ãƒƒãƒ—ï¼‰
  production-approval:
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: false # æœ¬ç•ªç’°å¢ƒæº–å‚™ä¸­ã®ãŸã‚ä¸€æ™‚çš„ã«ã‚¹ã‚­ãƒƒãƒ—
    # if: |
    #   github.event_name == 'push' &&
    #   github.ref == 'refs/heads/main' &&
    #   github.event.inputs.skip_approval != 'true'
    environment:
      name: production
      url: ${{ needs.deploy-frontend.outputs.prod-url }}
    steps:
      - name: æœ¬ç•ªãƒ‡ãƒ—ãƒ­ã‚¤æ‰¿èªå®Œäº†
        run: |
          echo "âœ… æœ¬ç•ªç’°å¢ƒã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ãŒæ‰¿èªã•ã‚Œã¾ã—ãŸ"
          echo "Frontend: ${{ needs.deploy-frontend.outputs.prod-url }}"
          echo "Backend: https://my-project-template-api-production.workers.dev"

  # ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸé€šçŸ¥
  notify-success:
    runs-on: ubuntu-latest
    needs: [deploy-frontend, deploy-backend]
    if: success()
    steps:
      - name: Slacké€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
        if: vars.SLACK_WEBHOOK_URL != ''
        run: |
          echo "ãƒ‡ãƒ—ãƒ­ã‚¤æˆåŠŸã‚’Slackã«é€šçŸ¥"
          # curl -X POST ${{ vars.SLACK_WEBHOOK_URL }} ...

      - name: ãƒ‡ãƒ—ãƒ­ã‚¤ã‚µãƒãƒªãƒ¼
        run: |
          echo "## ğŸ‰ ãƒ‡ãƒ—ãƒ­ã‚¤å®Œäº†"
          echo ""
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "### ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç’°å¢ƒ"
            echo "- Frontend: ${{ needs.deploy-frontend.outputs.preview-url }}"
            echo "- Backend: https://my-project-template-api-preview.workers.dev"
          else
            echo "### æœ¬ç•ªç’°å¢ƒ"
            echo "- Frontend: ${{ needs.deploy-frontend.outputs.prod-url }}"
            echo "- Backend: https://my-project-template-api-production.workers.dev"
          fi
